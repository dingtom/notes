```python
import cv2
import numpy as np
showImage = False
# 灰度形式读取放大4倍
card_GRAY = cv2.imread('bank_card41.jpg', 0)
card_GRAY4 = cv2.resize(card_GRAY, (4 * card_GRAY.shape[1], 4 * card_GRAY.shape[0]))
if showImage:
    cv2.imshow('card_GRAY4', card_GRAY4)
else:
    cv2.imwrite('card_GRAY4.jpg', card_GRAY4)

```

![](https://gitee.com/dingtom1995/picture/raw/master/2022-10-08/2022-10-08_11-27-50-188.png)

```python

# 自适应阈值 二值化
adaptiveThresh = cv2.adaptiveThreshold(
    card_GRAY4, 
    255, 
    cv2.ADAPTIVE_THRESH_MEAN_C,                      
    cv2.THRESH_BINARY_INV, 
    13, 
    3)
if showImage:
    cv2.imshow('adaptiveThresh', adaptiveThresh)
else:
    cv2.imwrite('adaptiveThresh.jpg', adaptiveThresh)
```

![](https://gitee.com/dingtom1995/picture/raw/master/2022-10-08/2022-10-08_11-38-21-524.png)

```python
# 轮廓筛选，用黑色填补小白点
contours, hierarchy = cv2.findContours(
    adaptiveThresh, 
    cv2.RETR_TREE,
    cv2.CHAIN_APPROX_SIMPLE)
# contours：list结构，列表中每个元素代表一个边沿信息。每个元素是(x,1,2)的三维向量，x表示该条边沿里共有多少个像素点，第三维的那个“2”表示每个点的横、纵坐标；

for i in range(len(contours)):
    if cv2.contourArea(contours[i]) < 160:
        adaptiveThresh = cv2.drawContours(
            adaptiveThresh, 
            contours, 
            i, 
            (0, 0, 0), 
            -1)
        
if showImage:
    cv2.imshow('adaptiveThresh2', adaptiveThresh)
else:
    cv2.imwrite('adaptiveThresh2.jpg', adaptiveThresh)
```

![](https://gitee.com/dingtom1995/picture/raw/master/2022-10-08/2022-10-08_11-41-07-605.png)

```python
# 黑帽提取空洞，颜色翻转？
blackhat = cv2.morphologyEx(
    adaptiveThresh, 
    cv2.MORPH_BLACKHAT, 
    np.ones((15, 15), dtype=np.uint8))

if showImage:
    cv2.imshow('blackhat', blackhat)
else:
    cv2.imwrite('blackhat.jpg', blackhat)
```

![](https://gitee.com/dingtom1995/picture/raw/master/2022-10-08/2022-10-08_14-21-18-376.png)

```python
# 开运算，消除噪音
opening = cv2.morphologyEx(
    blackhat, 
    cv2.MORPH_OPEN, 
    np.ones((3, 3), dtype=np.uint8))

if showImage:
    cv2.imshow('opening', opening)
else:
    cv2.imwrite('opening.jpg', opening)
```

![](https://gitee.com/dingtom1995/picture/raw/master/2022-10-08/2022-10-08_14-22-45-111.png)

```python
# 填补，面积过小、过大、长宽比不符的白点
contours, hierarchy = cv2.findContours(
    opening, 
    cv2.RETR_TREE,
    cv2.CHAIN_APPROX_SIMPLE)

for i in range(len(contours)):
    x, y, w, h = cv2.boundingRect(contours[i])
    aspect_ratio = float(w) / h
    Area = w * h
    
    if Area < 1800 or Area > 6000 or aspect_ratio > 0.7 or aspect_ratio < 0.5:
        opening = cv2.drawContours(
            opening, 
            contours, 
            i, 
            (0, 0, 0), 
            -1)
        
if showImage:
    cv2.imshow('opening2', opening)
else:
    cv2.imwrite('opening2.jpg', opening)
```

![](https://gitee.com/dingtom1995/picture/raw/master/2022-10-08/2022-10-08_14-24-10-504.png)

```python
# 数字太细，膨胀一下
dilation = cv2.dilate(
    opening, 
    np.ones((5, 5), np.uint8), 
    iterations=1)

if showImage:
    cv2.imshow('dilation', dilation)
else:
    cv2.imwrite('dilation.jpg', dilation)
```

![](https://gitee.com/dingtom1995/picture/raw/master/2022-10-08/2022-10-08_14-24-50-121.png)

```python
# 读取模板
numTemplate = cv2.imread('bankCardNumTemplate.jpg')
numTemplate_GRAY = cv2.cvtColor(
    numTemplate, 
    cv2.COLOR_BGR2GRAY)
ret, numTemplate_GRAY = cv2.threshold(
    numTemplate_GRAY, 
    200, 
    255, 
    cv2.THRESH_BINARY)

if showImage:
    cv2.imshow('numTemplate_GRAY', numTemplate_GRAY)
else:
    cv2.imwrite('numTemplate_GRAY.jpg', numTemplate_GRAY)
```

![](https://gitee.com/dingtom1995/picture/raw/master/2022-10-08/2022-10-08_14-49-23-124.png)

```python
# 提取出每个数字，并排序
def sequence_contours(image, width, height):
    contours, hierarchy = cv2.findContours(
        image, 
        cv2.RETR_EXTERNAL,
        cv2.CHAIN_APPROX_SIMPLE)
    RectBoxes = [cv2.boundingRect(c) for c in contours]
    RectBoxes.sort(key=lambda c: c[0])

    ImgBoxes = []
    for r in RectBoxes:
        x, y, w, h = r
        ROI = cv2.resize(
            image[y:y + h, x:x + w], 
            (width, height))
        
        # 尺寸变化像素点可能变得模糊
        thresh_val, ROI = cv2.threshold(
            ROI, 
            200, 
            255, 
            cv2.THRESH_BINARY)
        ImgBoxes.append(ROI)
    return ImgBoxes

ImgBoxes = sequence_contours(dilation, 50, 80)

ImgBoxes_Temp = sequence_contours(numTemplate_GRAY, 50, 80)

if showImage:
    cv2.imshow('ImgBoxes_Temp[1]', ImgBoxes_Temp[1])
else:
    cv2.imwrite('ImgBoxes_Temp[1].jpg', ImgBoxes_Temp[1])
```

![](https://gitee.com/dingtom1995/picture/raw/master/2022-10-08/2022-10-08_14-52-52-618.png)

```python

result = []
for i in ImgBoxes:
    scores = [cv2.matchTemplate(i, j, cv2.TM_SQDIFF) for j in ImgBoxes_Temp]
    scores = np.array(scores).squeeze()

    min_val, max_val, min_indx, max_indx = cv2.minMaxLoc(scores)
    result.append(min_indx[1])

print(result)

cv2.waitKey(0)
cv2.destroyAllWindows()
```

